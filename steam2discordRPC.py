#! /bin/env python3
import json
import os.path
import time
from pypresence import Client
import requests

default_config = {
  "client_id": '1007823600230879272',
  "steam_id": 'YOURSTEAMACCOUNTIDHERE',
  # All games with discord sdk according to https://steamdb.info/tech/SDK/Discord/?all
  "blacklist": ['1145360','1229490','433340','960090','253230','774181','284160','548430','632360','531510','386940','1102190','1290490','714010','897330','1229380','563560','1058830','1175140','774171','843380','259680','977950','207140','286160','613100','211820','681280','440310','453090','1206560','412220','764790','225840','945360','282800','568320','418530','1016920','960690','1435790','65800','803330','577690','591460','700330','677620','550320','604240','1280770','1130410','638490','980610','656350','1347970','489520','233610','1397920','1361510','572220','265630','753420','473770','230410','1919460','1358090','688420','1101180','1092630','1466640','322110','925460','574980','792710','218620','1104450','1029210','1196630','444640','224260','1465860','1343370','977400','589290','252950','1100990','323850','209080','1818750','1972440','998740','711540','811320','416600','529520','1674270','431930','1402020','864060','657690','589940','1055210','527230','1620690','607260','1481780','1444090','393380','690420','602320','94400','248570','949290','1400910','770810','232090','1463920','663670','1096060','1266980','434650','606710','602700','1469250','556050','1365940','686770','871930','1877960','560130','1259510','451020','1191580','337150','334540','1302240','17570','738650','1106840','391730','444090','1048660','442120','418460','1533470','1069030','867210','513510','504390','1577260','467760','1188080','633460','242860','1197260','1232100','1836310','489380','761910','1747890','726840','1477590','627270','1347550','1088150','581320','307110','1989990','734750','877850','823840','804530','1453490','1808060','438450','397540','865360','926860','1740720','469600','678800','504370','1569440','1249510','951440','1554400','1315980','1916310','1021880','957820','638990','474220','1361240','386070','17500','552500','346820','437610','1216230','661130','396900','583930','1066420','342940','565180','594650','505460','1502660','1057700','774861','1325900','1282760','1286730','833980','397680','732050','1485120','1818690','735580','1128810','1451650','1062830','652810','655740','1326700','1376070','667870','1856970','544550','17740','1435090','1948430','324080','598640','668980','1142220','1071190','1037080','1471490','802450','1156670','1417720','1393490','379210','1772490','1026160','382310','629760','1415320','1720090','740250','1677380','1278290','610410','291410','676500','1115780','839310','1299810','650220','1529560','1494840','1730110','569530','1024890','1359090','1248150','422860','1610900','761010','386360','1346420','967460','861520','269850','494840','1346210','1663930','367270','1646930','1767700','1605220','1016770','1253110','1427210','877870','681990','898910','1178680','449960','1133580','881130','673560','1626370','1497230','915810','1108590','774211','1314840','280180','1550710','667720','599160','1291060','1912500','1621070','286000','427730','1899810','1517890','545040','348910','640820','582330','1739100','468670','611190','1320230','1482860','1380400','1684080','676930','1916850','984610','1828210','1301100','1297090','1020800','797610','1506610','1694670','1570330','384960','1206610','872670','1282050','370770','1827980','454830','1744400','1652300','981630','839330','1235120','1178460','1333090','826600','1248650','736220','1332220','700240','1526930','969450','1127320','1090700','269190','595280','1326270','597180','257730','839200','616610','813820','1542060','1491530','745400','606280','1175540','1348250','1086900','681110','851150','1098270','509400','1343040','1966910','1404960','1550740','296300','1012970','1155580','1227570','1105810','1345400','1497590','727570','1506760','1538570','1461090','1155090','1764410','2000320','1575100','651150','1275380','608800','1455900','314980','1136020','1479150','1128190','465000','794260','1252240','975620','1069640','1799930','1240440','1048880','309900','1415830','879160','651490','611040','1579300','1219420','1433010','1386780','508650','377300','1659210','1618540','1383160','941150','1813340','1219740','1004620','433530','866080','1821060','752170','1047950','1126580','786180','1450180','1412190','1121200','1315660','911430','1048530','876780','1700690','1299750','551860','718650','708550','1268150','931450','1158370','238430','975510','611260','446510','1466100','1120390','1456250','1061550','1141390','1331650','1429400','1518320','1194170','1452280','362310','1498250','773840','1056330','505740','999860','421170','621940','492760','864700','1502920','795570','923710','1558100','341500','1937620','1174380','1453460','1398750','438100','810360','349710','743920','1397810','1519880','1927410','1414270','2011330','2094090','1710590','907290','1512960','994520','1206480','1545600','1819860','1173630','1058650','1443490','1584300','1468240','914700','1400520','766370','1304510','1595710','1259130','1054030','1180530','1227800','793360','1870490','535630','1223680','573490','330460','703280','985780','483850','1317070','1905310','1693540','1064520','625340','530630','1386040','556530','655780','876260','1362130','1281610','1096600','1068510','888130','1501100','386340','947940','556740','980640','1293540','611360','511440','1857370','1279330','969680','1090800','1361400','850290','971120','827520','1370660','719200','917850','892310','2090230','939100','1635450','931260','818390','987020','1364290','1882930','836850','225600','1794970','691280','1654440','1679800','1101220','701820','1010420','1732260','1730310','1964880','870740','1101840','1215960','623340','1175890','1394270','848010','838410','1387970','1640130','1274640','791260','956580','1898680','945140','793280','995310','750420','2005810','1221330','1847810','1404150','585630','511430','541300','1114630','322780','581460','1641300','964020','577210','706020','1278350','1065550','647590','1022310','492840','1387510','1479480','1509050','1203180','719640','1313580','1436900','795990','419700','1385970','886670','600280','513880','997060','1106750','1509420','1370940','1260160','895200','886120','1472740','1631930','1516960','1567690','1443810','1996800','1479340','852880','757780','1086670','1759400','958190','378370','590790','1195460','1104390','928170','945610','779380','787750','1600950','1525330','896510','748930','578080','1595250','1605550','1010590','1245900','1096610','1533960','1762120','1838670','608990','436260','809280','693800','953150','588210','1197730','333950','587540','1801630','1172430','1391690','925880','1278270','370350','611800','1575330','640150','1289380','1138440','663390','686090','828730','733430','1187520','1924510','1507800','1095360','1185410','485670','1229730','415860','1725130','782070','567320','1422180','1398010','1021120','1452080','1103140','1127460','1197110','838900','1748740','1683820','1893350','1459510','723390','1529100','1646730','1872550','1072660','684200','2015140','1621210','1626880','610210','1794710','1103630','1665490','1868030','671860','233250','560380','1245560','1556790','1249520','440000','601360','1363900','1380910','669270','1184790','1564600','622590','1479140','869480','349470','1611740','981870','435410','856890','1046760','1230760','1093390','1356810','1657090','1512190','766930','690100','819970','596350','749820','770720','1202920','367540','420040','1234040','1288900','1979310','1157720','1318990','862900','1828660','1594460','1022600','844630','1871440','1299520','1681770','1470110','672890','575440','1355230','774941','670510','737230','1047600','878760','544360','1686450','858460','1174620','1256400','1466660','1359640','1089690','777170','1718240','821840','1797270','1829770','1743780','929370','1144010','1802710','1472130','427460','1380340','1962220','1592890','1875460','1450160','1386350','339010','1613350','418500','2023760','1764570','1950990','1469760','1140300','2100730','1470590','1293680','1048810','743140','1975650','1648350','1647100','1630330','321210','694840','1972520','1829330','1818740','1722380','1641400','1606430','1574890','1802410','1792300','1176940','416880','2088370','2085250','1955810','1809430','1797460','1751090','1687630','1636390','1480270','1470240','1433270','771030','349110','2086510','1990390','1972010','1959090','1949540','1911460','1905470','1899870','1885150','1878060','1868690','1813960','1790390','1771950','1744190','1722230','1687750','1686660','1676540','1664300','1618270','1617100','1599650','1560300','1538020','1513380','1512420','1472150','1404690','1313620','1301040','1018630','1010030','992760','450980','2099800','2097340','2092500','2091860','2086310','2083070','2075740','2073670','2051260','2023860','2020760','2018630','2018470','2017650','2013310','2011930','2009690','2005840','2002640','2001950','1996940','1995140','1982040','1978600','1974140','1968090','1956010','1950260','1946800','1940050','1922230','1911100','1907530','1905650','1901320','1899860','1885210','1884270','1880530','1879090','1868740','1864920','1858800','1851040','1848020','1813880','1808180','1795450','1777040','1766640','1762880','1760390','1755940','1755490','1741880','1740280','1736050','1732040','1731800','1725110','1723090','1719580','1711780','1708380','1703250','1698830','1686330','1679780','1677680','1661410','1653680','1649200','1647570','1647230','1641030','1639880','1633900','1624650','1621570','1614610','1614060','1605470','1597690','1597620','1588020','1579350','1555060','1548250','1542730','1541820','1539410','1535750','1517070','1504280','1503080','1501430','1496740','1493780','1491440','1491160','1484570','1479820','1474980','1469640','1468170','1452710','1442760','1439640','1433700','1429770','1428010','1427500','1425100','1424390','1422800','1418500','1410350','1409280','1407770','1407260','1403670','1401470','1398160','1397730','1397670','1397610','1394850','1384730','1382150','1376130','1375660','1355040','1352550','1328260','1327880','1327110','1326350','1326320','1325490','1325390','1324210','1323780','1323150','1321830','1321510','1321410','1319980','1319020','1317320','1315020','1313990','1310640','1310440','1307970','1307040','1302640','1300930','1300780','1297610','1297100','1296350','1295370','1293010','1267570','1266550','1265400','1264380','1260870','1255580','1253660','1230260','1224950','1217980','1216170','1180760','1164510','1139250','1138840','1137140','1131860','1127000','1104950','1093100','1088970','1084780','1080980','1078900','1077380','1075440','1073540','1067170','1064780','1046810','1026990','1007020','1003720','1000730','998900','996560','994580','980710','969170','930890','894280','885540','884510','884110','880760','870500','870490','844650','786920','773860','772660','764190','746200','743430','670530','669980','656800','651040','643090','639660','629800','628220','622050','620110','619240','600760','598650','582400','581330','533830','532330','529980','424980','424970','418480','407660','407480','403240','367970','345070','317670','293030','276060','232130','231850','229680','228780','17575','1937920','1797170','1690230','1684040','1603250','1502300','1486940','1440550','1424230','1305460','1288730','1284580','1283700','1279430','1197420','1196640','1185980','1179970','1175740','1172160','1158570','1152470','1145720','1136200','1136190','1110990','1093030','1071470','1069780','1046040','1019750','1012110','1007090','1005260','967480','960060','931240','888930','857070','845220','813990','812370','774961','761260','689410','355470','331700']
}

if not os.path.exists('config.json'):
  configfile = open("config.json", "w")
  json.dump(default_config, configfile)
  configfile.close()

configfile = open("config.json", "r")
config = json.load(configfile)


discord_rpc = Client(config['client_id'])
while True:
  try:
    discord_rpc.start()
    break
  except ConnectionRefusedError:
    time.sleep(5*60)
discord_rpc.clear_activity()

while True:
  response = requests.post('https://steam-chat.com/miniprofile/' + config['steam_id'] + '/json/')
  try:
    print(response.json()["in_game"])
    app_pos = response.json()["in_game"]["logo"].find("apps/")
    appid = response.json()["in_game"]["logo"][app_pos + 5:-19]
    if appid in config['blacklist'] or response.json()["in_game"]["is_non_steam"]:
      print('ignored')
      discord_rpc.clear_activity()
      time.sleep(120)
    else:
      print(appid) #TODO: appid based override
      state = response.json()["in_game"]["rich_presence"]
      if state == "": state = None
      discord_rpc.set_activity(
        state = state,
        large_image = 'https://cdn.cloudflare.steamstatic.com/steam/apps/' + appid + '/hero_capsule.jpg',
        details = response.json()["in_game"]["name"],
        buttons = [{"label": "Open Store Page", "url": "https://store.steampowered.com/app/" + appid}, {"label": "Launch Game", "url": "steam://run/" + appid}]
      )
      time.sleep(30)
  except KeyError:
    discord_rpc.clear_activity()
    time.sleep(120)
